<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AchuNails - Panel de Control</title>
  <link rel="icon" type="image/png" href="../img/achunailslogo3.png">
  
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { 'baby-pink': '#FFD6E0', 'soft-pink': '#FFF0F3', 'rose-gold': '#E8B4B8', 'deep-pink': '#C9929A', 'glam-pink': '#FF85A1' } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>

<body class="h-screen bg-soft-pink flex font-['Poppins'] text-gray-800 overflow-hidden">

  <aside class="w-full md:w-64 glass-card border-r border-baby-pink flex flex-col p-6 shadow-md z-10 shrink-0 min-h-screen">
    <div class="text-center mb-10">
      <img src="../img/achunailslogo2.png" alt="Logo AchuNails" class="h-20 mx-auto mb-3 object-contain rounded-full p-1 bg-soft-pink/50">
      <h2 class="font-['Quicksand'] text-xl font-bold text-glam-pink">Achu Nails</h2>
    </div>

    <nav class="flex-1 space-y-2">
      <a href="calculadora.html" class="flex items-center space-x-3 text-deep-pink hover:bg-baby-pink/50 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">üíÖüèª</span> <span>Nueva Cotizaci√≥n</span>
      </a>

      <a href="dashboard.html" class="flex items-center space-x-3 bg-glam-pink text-white px-4 py-3 rounded-xl shadow-sm font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">üìä</span> <span>M√©tricas</span>
      </a>
      
      <a href="historial.html" class="flex items-center space-x-3 text-deep-pink hover:bg-baby-pink/50 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">üìã</span> <span>Historial de Servicios</span>
      </a>
    </nav>

    <div class="mt-auto pt-6 border-t border-baby-pink">
      <a href="../index.html" class="flex items-center space-x-3 text-deep-pink hover:bg-red-50 hover:text-red-500 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">Cerrar Sesi√≥n</span>
      </a>
    </div>
  </aside>

  <main class="flex-1 p-6 md:p-10 overflow-auto">
    
    <header class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold font-['Quicksand'] text-deep-pink">¬°Hola, Azul! üëãüèª</h1>
        <p class="text-gray-500 text-sm mt-1">Este es el balance de tu sal√≥n este mes.</p>
      </div>
      <button class="bg-white border-2 border-baby-pink text-deep-pink px-4 py-2 rounded-xl font-semibold hover:bg-baby-pink transition-all shadow-sm">
        üìÖ <span id="mes-actual">Febrero 2026</span>
      </button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      
      <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink">
        <h3 class="text-sm font-semibold text-deep-pink mb-1">Ingresos del Mes</h3>
        <p id="ingresos-mes" class="text-3xl font-bold text-glam-pink">$0</p>
        <span class="text-xs text-green-500 font-medium mt-2 block">En lo que va del mes</span>
      </div>

      <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink">
        <h3 class="text-sm font-semibold text-deep-pink mb-1">Servicios Realizados</h3>
        <p id="total-servicios" class="text-3xl font-bold text-glam-pink">0</p>
        <span id="servicios-promedio" class="text-xs text-gray-500 font-medium mt-2 block">Promedio: 0 por d√≠a</span>
      </div>

      <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink">
        <h3 class="text-sm font-semibold text-deep-pink mb-1"> Destacado üåü</h3>
        <p id="mejor-servicio-nombre" class="text-xl font-bold text-glam-pink mt-1">-</p>
        <span id="mejor-servicio-cantidad" class="text-xs text-gray-500 font-medium mt-2 block">0 aplicaciones este mes</span>
      </div>

    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink h-80 relative w-full flex flex-col">
        <h3 class="text-sm font-semibold text-deep-pink mb-2">Ingresos de la Semana</h3>
        <div class="relative flex-1 w-full h-full">
          <canvas id="ventasChart"></canvas>
        </div>
      </div>

      <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink h-80 relative w-full flex flex-col">
        <h3 class="text-sm font-semibold text-deep-pink mb-2">Resumen de servicios </h3>
        <div class="relative flex-1 w-full h-full pb-2">
          <canvas id="serviciosChart"></canvas>
        </div>
      </div>

    </div>

    <div class="glass-card p-6 rounded-2xl shadow-sm border border-baby-pink mb-8">
      <h3 class="text-lg font-bold font-['Quicksand'] text-deep-pink mb-4 flex items-center"> √öltimos registrados</h3>
      
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse min-w-[600px]">
          <thead>
            <tr class="text-deep-pink/70 text-sm border-b border-baby-pink">
              <th class="pb-3 font-semibold">Fecha</th>
              <th class="pb-3 font-semibold">Servicio Detallado</th>
              <th class="pb-3 font-semibold">M√©todo de Pago</th>
              <th class="pb-3 font-semibold text-right">Total</th>
            </tr>
          </thead>
          <tbody id="tabla-ventas-body" class="text-sm text-gray-600">
            </tbody>
        </table>
      </div>
    </div>
    <div id="ticket-modal" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-all">
      <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full relative border-2 border-baby-pink">
        
        <button onclick="cerrarTicket()" class="absolute top-4 right-5 text-deep-pink hover:text-glam-pink text-3xl font-bold transition-all">&times;</button>
        
        <div class="text-center mb-6 mt-2">
          <img src="../img/achunailslogo2.png" alt="Logo" class="h-16 mx-auto mb-2 object-contain rounded-full">
          <h2 class="font-['Quicksand'] text-2xl font-bold text-glam-pink">Achu Nails</h2>
          <p class="text-xs text-gray-500 mt-1" id="ticket-fecha">-</p>
        </div>
        
        <div class="border-t border-b border-dashed border-glam-pink py-4 mb-4 bg-soft-pink/30 px-3 rounded-lg">
          <p class="text-xs text-deep-pink font-semibold mb-2 uppercase tracking-wider">Detalle del Servicio:</p>
          <p class="text-gray-700 text-sm leading-relaxed" id="ticket-detalle">-</p>
        </div>
        
        <div class="flex justify-between items-center mb-2 text-sm px-1">
          <span class="text-deep-pink font-medium">M√©todo de Pago:</span>
          <span class="font-semibold text-gray-700" id="ticket-pago">-</span>
        </div>
        
        <div class="flex justify-between items-center mt-4 pt-4 border-t border-baby-pink px-1">
          <span class="font-bold text-deep-pink text-lg">Total Final:</span>
          <span class="font-bold text-glam-pink text-2xl" id="ticket-total">$0</span>
        </div>
        
      </div>
    </div>
  </main>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Variables globales para guardar los gr√°ficos
    let chartVentas = null;
    let chartServicios = null;

    async function cargarDatosReales() {
      try {
        const respuesta = await fetch('../api/obtener_ventas.php');
        const ventas = await respuesta.json();

        let ingresosTotales = 0;
        let cantidadServicios = ventas.length;
        
        // Diccionarios para guardar los c√°lculos matem√°ticos
        const conteoServicios = {};
        const ingresosPorDia = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}; // 0=Domingo, 1=Lunes, etc.
        
        const tablaBody = document.getElementById('tabla-ventas-body');
        tablaBody.innerHTML = '';

        ventas.forEach(venta => {
          const precio = parseFloat(venta.total);
          ingresosTotales += precio;

          // 1. L√≥gica de Fechas (Para la tabla y el gr√°fico de barras)
          const fecha = new Date(venta.fecha_registro);
          const diaSemana = fecha.getDay(); // Saca qu√© d√≠a de la semana es (0 al 6)
          ingresosPorDia[diaSemana] += precio; // Suma la plata a ese d√≠a espec√≠fico

          const fechaFormateada = fecha.toLocaleDateString('es-AR') + ' ' + fecha.toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});

          // 2. L√≥gica de Servicios (Extraemos la t√©cnica principal cortando en el "+")
          const tecnicaPrincipal = venta.detalle_servicio.split(' + ')[0].trim();
          
          // Si el servicio ya existe en la lista, le sumamos 1, sino lo creamos en 1
          if (conteoServicios[tecnicaPrincipal]) {
             conteoServicios[tecnicaPrincipal] += 1;
          } else {
             conteoServicios[tecnicaPrincipal] = 1;
          }

          // Escapamos comillas simples por si acaso en el texto
          const detalleSeguro = venta.detalle_servicio.replace(/'/g, "\\'"); 
          
          // 3. Dibujar la fila de la tabla (¬°Ahora es clickeable!)
          const fila = `
            <tr onclick="abrirTicket('${fechaFormateada}', '${detalleSeguro}', '${venta.metodo_pago}', ${precio})" class="border-b border-soft-pink hover:bg-baby-pink/40 transition-all cursor-pointer group">
              <td class="py-3 px-2 group-hover:text-glam-pink transition-colors">${fechaFormateada}</td>
              <td class="py-3 font-medium text-deep-pink truncate max-w-[200px]">${venta.detalle_servicio}</td>
              <td class="py-3">${venta.metodo_pago === 'Efectivo' ? ' Efectivo' : ' Transferencia'}</td>
              <td class="py-3 text-right font-bold text-glam-pink pr-2">$${precio.toLocaleString('es-AR')}</td>
            </tr>
          `;
          tablaBody.innerHTML += fila;
        });

        // 4. Calcular cu√°l fue el Mejor Servicio
        let mejorServicio = '-';
        let maxAplicaciones = 0;
        
        for (const [servicio, cantidad] of Object.entries(conteoServicios)) {
            if (cantidad > maxAplicaciones) {
                maxAplicaciones = cantidad;
                mejorServicio = servicio;
            }
        }

        // 5. Escribir los n√∫meros en las tarjetas de arriba
        document.getElementById('ingresos-mes').textContent = '$' + ingresosTotales.toLocaleString('es-AR');
        document.getElementById('total-servicios').textContent = cantidadServicios;
        document.getElementById('mejor-servicio-nombre').textContent = mejorServicio;
        document.getElementById('mejor-servicio-cantidad').textContent = maxAplicaciones + (maxAplicaciones === 1 ? ' aplicaci√≥n' : ' aplicaciones');
        const diaActual = new Date().getDate(); // Saca qu√© d√≠a del mes es hoy (ej: 23)
        const promedio = (cantidadServicios / diaActual).toFixed(1); // Divide y deja 1 decimal
        document.getElementById('servicios-promedio').textContent = `Promedio: ${promedio} por d√≠a`;

        // 6. ¬°Por √∫ltimo, mandamos estos datos calculados a dibujar los gr√°ficos!
        dibujarGraficos(ingresosPorDia, conteoServicios);

      } catch (error) {
        console.error('Error al cargar las ventas:', error);
      }
    }

    function dibujarGraficos(ingresosPorDia, conteoServicios) {
      // --- GR√ÅFICO DE BARRAS (Ordenamos los d√≠as de Lunes a Domingo) ---
      const diasOrdenados = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
      const datosDias = [
        ingresosPorDia[1], ingresosPorDia[2], ingresosPorDia[3], 
        ingresosPorDia[4], ingresosPorDia[5], ingresosPorDia[6], ingresosPorDia[0]
      ];

      const ctxVentas = document.getElementById('ventasChart').getContext('2d');
      if(chartVentas) chartVentas.destroy(); // Borramos el gr√°fico anterior si lo hubiera
      chartVentas = new Chart(ctxVentas, {
        type: 'bar',
        data: {
          labels: diasOrdenados,
          datasets: [{
            label: 'Ingresos',
            data: datosDias,
            backgroundColor: '#FF85A1',
            hoverBackgroundColor: '#C9929A',
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => '$' + c.raw.toLocaleString('es-AR') } } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v) => '$' + v.toLocaleString('es-AR') }, grid: { color: 'rgba(255, 214, 224, 0.5)' } }, x: { grid: { display: false } } }
        }
      });

      // --- GR√ÅFICO CIRCULAR (Donut) ---
      const labelsServicios = Object.keys(conteoServicios);
      const dataServicios = Object.values(conteoServicios);
      const paletaRosa = ['#FF85A1', '#FFD6E0', '#E8B4B8', '#C9929A', '#FFB3C6', '#FF9EBB', '#F7C8D0'];

      const ctxServicios = document.getElementById('serviciosChart').getContext('2d');
      if(chartServicios) chartServicios.destroy();
      chartServicios = new Chart(ctxServicios, {
        type: 'doughnut',
        data: {
          labels: labelsServicios,
          datasets: [{
            data: dataServicios,
            backgroundColor: paletaRosa.slice(0, labelsServicios.length),
            borderWidth: 3,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { font: { family: 'Poppins' }, color: '#C9929A', usePointStyle: true, padding: 20 } } },
          cutout: '75%'
        }
      });
    }

    // Iniciar todo al cargar la p√°gina
    cargarDatosReales();
    // --- NUEVO: Funciones para el Modal del Ticket ---
    function abrirTicket(fecha, detalle, pago, total) {
      document.getElementById('ticket-fecha').textContent = fecha;
      
      // Truco visual: Reemplazamos los "+" por saltos de l√≠nea para que quede como una lista de compras
      document.getElementById('ticket-detalle').innerHTML = detalle.replace(/\+/g, '<br><span class="text-glam-pink font-bold">+</span> ');
      
      document.getElementById('ticket-pago').textContent = pago === 'Efectivo' ? 'üíµ Efectivo' : 'üì± Transferencia';
      document.getElementById('ticket-total').textContent = '$' + total.toLocaleString('es-AR');
      
      // Mostramos el recuadro oscurecido
      document.getElementById('ticket-modal').classList.remove('hidden');
    }

    function cerrarTicket() {
      // Ocultamos el recuadro
      document.getElementById('ticket-modal').classList.add('hidden');
    }
    // --- NUEVO: Actualizar el mes autom√°ticamente ---
    function mostrarMesActual() {
      // 1. Creamos nuestro diccionario de meses
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // 2. Le preguntamos a la computadora qu√© d√≠a es hoy
      const hoy = new Date();
      const nombreMes = meses[hoy.getMonth()]; // Saca el mes actual
      const anio = hoy.getFullYear(); // Saca el a√±o actual
      
      // 3. Buscamos el <span> que creamos y le inyectamos el texto real
      const elementoMes = document.getElementById('mes-actual');
      if(elementoMes) {
          elementoMes.textContent = nombreMes + ' ' + anio;
      }
    }

    // 4. Encendemos el motor al cargar la p√°gina
    mostrarMesActual();
  </script>

</body>
</html>
</body>
</html>