<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial - Achu Nails</title>
    <link rel="icon" type="image/png" href="../img/achunailslogo3.png">
  
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { 'baby-pink': '#FFD6E0', 'soft-pink': '#FFF0F3', 'rose-gold': '#E8B4B8', 'deep-pink': '#C9929A', 'glam-pink': '#FF85A1' } } } }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
</head>

<body class="h-screen bg-soft-pink flex font-['Poppins'] text-gray-800 overflow-hidden">

  <aside class="w-full md:w-64 glass-card border-r border-baby-pink flex flex-col p-6 shadow-md z-10 shrink-0 min-h-screen">
    <div class="text-center mb-10">
      <img src="../img/achunailslogo2.png" alt="Logo AchuNails" class="h-20 mx-auto mb-3 object-contain rounded-full p-1 bg-soft-pink/50">
      <h2 class="font-['Quicksand'] text-xl font-bold text-glam-pink">Achu Nails</h2>
    </div>
    <nav class="flex-1 space-y-3">
        <a href="calculadora.html" class="flex items-center space-x-3 text-deep-pink hover:bg-baby-pink/50 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">üíÖüèª</span> <span>Nueva Cotizaci√≥n</span>
      </a>

        <a href="dashboard.html" class="flex items-center space-x-3 text-deep-pink hover:bg-baby-pink/50 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl">üìä</span> <span>M√©tricas</span>
      </a>

      <a href="historial.html" class="flex items-center space-x-4 text-white bg-glam-pink px-4 py-3 rounded-xl shadow-md font-bold transition-all">
        <span class="text-xl">üìã</span> <span>Historial de Servicios</span>
      </a>
    </nav>

    <div class="mt-auto pt-6 border-t border-baby-pink">
      <a href="../index.html" class="flex items-center space-x-3 text-deep-pink hover:bg-red-50 hover:text-red-500 px-4 py-3 rounded-xl font-semibold font-['Poppins'] transition-all">
        <span class="text-xl"> Cerrar Sesi√≥n</span>
      </a>
    </div>
  </aside>

  <main class="flex-1 p-8 md:p-12 overflow-y-auto font-['Poppins']">
    <header class="mb-8">
      <h1 class="text-3xl font-bold font-['Quicksand'] text-deep-pink">Historial de Servicios üìã</h1>
      <p class="text-gray-500 text-sm mt-1">Busca, filtra y analiza todos los trabajos realizados.</p>
    </header>

    <div class="bg-white p-6 rounded-3xl shadow-sm border border-baby-pink mb-8 flex flex-wrap gap-5 items-end">
      
      <div class="w-full md:w-auto">
        <label class="block text-sm font-semibold text-deep-pink mb-2">Fecha (D√≠a exacto o Desde):</label>
        <input type="date" id="filtro-desde" onchange="aplicarFiltros()" class="w-full border border-baby-pink rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-glam-pink text-gray-600 bg-soft-pink/20 font-medium">
      </div>
      
      <div class="w-full md:w-auto">
        <label class="block text-sm font-semibold text-deep-pink mb-2">Hasta (Opcional):</label>
        <input type="date" id="filtro-hasta" onchange="aplicarFiltros()" class="w-full border border-baby-pink rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-glam-pink text-gray-600 bg-soft-pink/20 font-medium">
      </div>
      
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-semibold text-deep-pink mb-2">T√©cnica:</label>
        <select id="filtro-servicio" onchange="aplicarFiltros()" class="w-full border border-baby-pink rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-glam-pink cursor-pointer text-gray-600 bg-soft-pink/20 font-medium appearance-none" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'%23FF85A1\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M19 9l-7 7-7-7\'/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em;">
          <option value="todos">Todas las t√©cnicas</option>
          <option value="semipermanente manos">Semipermanente Manos</option>
          <option value="semipermanente pies">Semipermanente Pies</option>
          <option value="kapping">Kapping Gel</option>
          <option value="soft gel">Soft Gel</option>
          <option value="esculpidas">Esculpidas</option>
        </select>
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-sm font-semibold text-deep-pink mb-2">M√©todo de Pago:</label>
        <select id="filtro-pago" onchange="aplicarFiltros()" class="w-full border border-baby-pink rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-glam-pink cursor-pointer text-gray-600 bg-soft-pink/20 font-medium appearance-none" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'%23FF85A1\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M19 9l-7 7-7-7\'/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.2em;">
          <option value="todos">Todos</option>
          <option value="Efectivo">Efectivo</option>
          <option value="Transferencia">Transferencia</option>
        </select>
      </div>

      <div class="w-full md:w-auto h-[42px]">
        <button onclick="limpiarFiltros()" class="w-full h-full bg-white border border-baby-pink text-deep-pink font-semibold px-6 rounded-xl text-sm hover:bg-baby-pink transition-colors">
          Limpiar Filtros
        </button>
      </div>
    </div>

    <div class="bg-white p-8 rounded-3xl shadow-sm border border-baby-pink">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <h3 class="text-xl font-bold font-['Quicksand'] text-deep-pink">Resultados</h3>
          <span class="text-sm font-semibold bg-white px-5 py-2.5 rounded-xl border border-baby-pink text-gray-500 flex items-center gap-2 shadow-sm">
            Total Filtrado: <span id="total-filtrado" class="text-lg font-bold text-glam-pink">$0</span>
          </span>
      </div>
      
      <div class="overflow-x-auto max-h-[500px] overflow-y-auto pr-2">
        <table class="w-full text-left border-collapse min-w-[700px]">
          <thead class="sticky top-0 bg-white z-10 shadow-sm">
            <tr class="text-deep-pink text-sm border-b-2 border-baby-pink font-semibold">
              <th class="py-4 px-4">Fecha</th>
              <th class="py-4 px-4">Servicio Detallado</th>
              <th class="py-4 px-4 text-center">M√©todo de Pago</th>
              <th class="py-4 px-4 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="tabla-historial-body" class="text-sm text-gray-600 divide-y divide-baby-pink/30">
            </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    let todasLasVentas = [];

    async function cargarHistorial() {
      try {
        const respuesta = await fetch('../api/obtener_ventas.php');
        todasLasVentas = await respuesta.json();
        renderizarTabla(todasLasVentas); 
      } catch (error) {
        console.error('Error al cargar ventas:', error);
        document.getElementById('tabla-historial-body').innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 font-medium">Error al cargar los datos. Intente nuevamente.</td></tr>';
      }
    }

    function renderizarTabla(ventasParaMostrar) {
       const tablaBody = document.getElementById('tabla-historial-body');
       tablaBody.innerHTML = '';
       let sumaTotal = 0;

       if (ventasParaMostrar.length === 0) {
           tablaBody.innerHTML = '<tr><td colspan="4" class="text-center py-12 text-gray-400 font-medium text-lg">No se encontraron servicios con estos filtros.</td></tr>';
       }

       ventasParaMostrar.forEach(venta => {
           const precio = parseFloat(venta.total);
           sumaTotal += precio;

           const fecha = new Date(venta.fecha_registro);
           const fechaFormateada = fecha.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + fecha.toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit', hour12: true});

           let pagoHtml = '';
           if (venta.metodo_pago === 'Efectivo') {
               pagoHtml = '<span class="px-3 py-1 rounded-md text-xs font-bold bg-green-100 text-green-700 border border-green-200"> Efectivo </span>';
           } else {
               pagoHtml = '<span class="px-3 py-1 rounded-md text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200"> Transferencia </span>';
           }

           const fila = `
             <tr class="hover:bg-soft-pink/30 transition-all">
               <td class="py-5 px-4 font-medium text-gray-500 whitespace-nowrap">${fechaFormateada}</td>
               <td class="py-5 px-4 font-medium text-deep-pink">${venta.detalle_servicio}</td>
               <td class="py-5 px-4 whitespace-nowrap text-center">${pagoHtml}</td>
               <td class="py-5 px-4 text-right font-bold text-glam-pink whitespace-nowrap text-lg">$${precio.toLocaleString('es-AR')}</td>
             </tr>
           `;
           tablaBody.innerHTML += fila;
       });

       document.getElementById('total-filtrado').textContent = '$' + sumaTotal.toLocaleString('es-AR');
    }

    function aplicarFiltros() {
       const fechaDesde = document.getElementById('filtro-desde').value;
       const fechaHasta = document.getElementById('filtro-hasta').value;
       const servicioBuscado = document.getElementById('filtro-servicio').value.toLowerCase();
       const metodoPago = document.getElementById('filtro-pago').value;

       const ventasFiltradas = todasLasVentas.filter(venta => {
           const fechaVentaStr = venta.fecha_registro.split(' ')[0]; 
           
           let pasaFiltroFecha = true;
           if (fechaDesde && !fechaHasta) {
               pasaFiltroFecha = (fechaVentaStr === fechaDesde);
           } else if (fechaDesde && fechaHasta) {
               pasaFiltroFecha = (fechaVentaStr >= fechaDesde && fechaVentaStr <= fechaHasta);
           } else if (!fechaDesde && fechaHasta) {
               pasaFiltroFecha = (fechaVentaStr <= fechaHasta);
           }

           let pasaFiltroServicio = true;
           if (servicioBuscado && servicioBuscado !== 'todos') {
               pasaFiltroServicio = venta.detalle_servicio.toLowerCase().includes(servicioBuscado);
           }

           let pasaFiltroPago = true;
           if (metodoPago && metodoPago !== 'todos') {
               pasaFiltroPago = (venta.metodo_pago === metodoPago);
           }

           return pasaFiltroFecha && pasaFiltroServicio && pasaFiltroPago;
       });

       renderizarTabla(ventasFiltradas);
    }

    function limpiarFiltros() {
        document.getElementById('filtro-desde').value = '';
        document.getElementById('filtro-hasta').value = '';
        document.getElementById('filtro-servicio').value = 'todos';
        document.getElementById('filtro-pago').value = 'todos';
        renderizarTabla(todasLasVentas);
    }

    cargarHistorial();
  </script>
</body>
</html>
</html>